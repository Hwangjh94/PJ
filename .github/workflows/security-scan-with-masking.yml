name: Terraform Security Scan with Auto-Masking

on:
  push:
    branches: [ main, master ]
    paths:
      - '**/*.tf'
      - '.github/workflows/security-scan-with-masking.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - '**/*.tf'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install boto3 pandas scikit-learn requests pyyaml
        
    - name: Install security tools
      run: |
        # tfsec ì„¤ì¹˜
        curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
        
        # Checkov ì„¤ì¹˜
        pip install checkov
        
        # Terrascan ì„¤ì¹˜
        curl -L "$(curl -s https://api.github.com/repos/accurics/terrascan/releases/latest | grep -o -E "https://.+?_Linux_x86_64.tar.gz")" > terrascan.tar.gz
        tar -xf terrascan.tar.gz terrascan && rm terrascan.tar.gz
        sudo install terrascan /usr/local/bin && rm terrascan
        
    - name: Run security scan
      id: security_scan
      run: |
        python -c "
        from src.terraform_analyzer.terraform_scanner import TerraformScanner
        import os
        import json
        
        scanner = TerraformScanner('./terraform')
        results = scanner.run_all_scans(use_mock=True)  # ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” Falseë¡œ ì„¤ì •
        
        # ê²°ê³¼ íŒŒì¼ì— ì €ì¥
        with open('scan_results.json', 'w') as f:
            json.dump(results, f, indent=2)
        
        # GitHub Actionsì— ê²°ê³¼ ì¶œë ¥
        has_critical = results.get('has_critical', False)
        if has_critical:
            critical_count = len(results.get('critical_findings', []))
            print(f'::warning::ì‹¬ê°í•œ ë³´ì•ˆ ì·¨ì•½ì  {critical_count}ê°œ ë°œê²¬!')
            print('::set-output name=has_critical::true')
            print(f'::set-output name=critical_count::{critical_count}')
        else:
            print('::set-output name=has_critical::false')
            print('::set-output name=critical_count::0')
        "
        
    - name: Apply auto-masking
      if: steps.security_scan.outputs.has_critical == 'true'
      run: |
        echo "ì‹¬ê°í•œ ì·¨ì•½ì  ë°œê²¬! ìë™ ë§ˆìŠ¤í‚¹ ì ìš© ì¤‘..."
        python -c "
        from src.lambda_functions.auto_masking_lambda import apply_masking
        import json
        import os
        
        # ìŠ¤ìº” ê²°ê³¼ ë¡œë“œ
        with open('scan_results.json', 'r') as f:
            results = json.load(f)
        
        # ì·¨ì•½ì ë³„ ë§ˆìŠ¤í‚¹ ì ìš©
        masked_count = 0
        for finding in results.get('critical_findings', []):
            # Terraform íŒŒì¼ ì½ê¸°
            file_path = finding.get('file', '')
            if not file_path or not os.path.exists(file_path):
                print(f'íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: {file_path}')
                continue
                
            with open(file_path, 'r') as f:
                content = f.read()
            
            # ë§ˆìŠ¤í‚¹ ì ìš©
            rule_id = finding.get('rule_id', '')
            resource = finding.get('resource', '')
            line_start = finding.get('line_start', 0)
            
            result, modified_content = apply_masking(content, rule_id, resource, line_start)
            
            if result:
                # ìˆ˜ì •ëœ ë‚´ìš© ì €ì¥
                with open(file_path, 'w') as f:
                    f.write(modified_content)
                masked_count += 1
                print(f'ë§ˆìŠ¤í‚¹ ì ìš©ë¨: {file_path}, ë¦¬ì†ŒìŠ¤: {resource}, ê·œì¹™: {rule_id}')
        
        print(f'ì´ {masked_count}ê°œì˜ ì·¨ì•½ì ì´ ìë™ ë§ˆìŠ¤í‚¹ë˜ì—ˆìŠµë‹ˆë‹¤.')
        "
        
    - name: Commit changes if any
      if: steps.security_scan.outputs.has_critical == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A
        git diff --quiet && git diff --staged --quiet || (git commit -m "ğŸ›¡ï¸ ìë™ ë³´ì•ˆ ì·¨ì•½ì  ë§ˆìŠ¤í‚¹ ì ìš©" -m "ë³´ì•ˆ ê²€ì‚¬ ë„êµ¬ê°€ ë°œê²¬í•œ ì·¨ì•½ì ì„ ìë™ìœ¼ë¡œ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤." && git push)